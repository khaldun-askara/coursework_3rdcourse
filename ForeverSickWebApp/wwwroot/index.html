<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавление информации о диагнозах</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@1.1/dist/css/tom-select.css" rel="stylesheet">
</head>

<body>
    <main class="p-3">
        <form id="diagnosis-form" class="p-2">
            <div class="mb-2">
                <label class="form-label">Выберите диагноз, для которого вы хотите добавить информацию. Для поиска начните печатать название:</label>

                <!-- Poorly handles resizing. -->
                <select id="diagnoses" class="form-control js-example-basic-single" placeholder="Введите название"></select>
            </div>

            <div class="mb-2">
                <div class="d-flex justify-content-between flex-row flex-nowrap">

                    <label class="form-label">Перечислите и опишите симптомы, характерные для этого диагноза. Если вы не хотите добавлять симптомы, оставьте поле пустым.</label>
                    <button id="fstButton" class="btn btn-primary mb-2" type="button" data-bs-toggle="popover"
                            data-bs-trigger="hover focus" data-bs-content="Для описания каждого симптома постарайтесь ответить на ряд вопросов: Как называется симптом? Состояние чего он показывает? Какие у него могут быть значения при этом диагнозе? Какие у него нормальные значения? Плохой пример описания: &quot;высокая температура&quot;. Хороший пример описания: &quot;для диагноза характерна повышенная температура тела от 37,5 до 39 при нормальном значении от 35,5 до 37,2&quot;. Такая подробность описаний необходима для реализации игровой логики.">
                        ?
                    </button>
                </div>

                <textarea id="simptoms" class="form-control" placeholder="Введите подробную информацию о симтомах. Если вам необходим пример, воспользуйтесь подсказкой справа." cols="80" rows="5"></textarea>
            </div>

            <div class="mb-2">
                <div class="d-flex justify-content-between flex-row flex-nowrap">
                    <label class="form-label">Какие визуальные проявления могут быть у больного? Опишите, пожалуйста, как можно подробнее. Можете вставить ссылки на необходимые иллюстрации. Если вы не хотите добавлять визуальные проявления, оставьте поле пустым.</label>
                    <button class="btn btn-primary mb-2" type="button" data-bs-toggle="popover"
                            data-bs-trigger="hover focus" data-bs-content="Визуальные проявления болезней добавляются в игру художником, которому необходимо знать, что изобразить. Опишите, как это выглядит, либо приведите термин, который можно поискать в интернете и найти иллюстрации, либо просто вставьте ссылку на общедоступную картинку. Плохой пример описания: &quot;сыпь&quot;. Хороший пример описания: &quot;красноватые пятна небольшого размера, в большом количестве расположенные на щеках, подбородке и шее&quot;.">
                        ?
                    </button>
                </div>

                <textarea id="visuals" class="form-control" placeholder="Введите подробную информацию о визуальных проявлениях. Если вам необходим пример, воспользуйтесь подсказкой справа." cols="80" rows="5"></textarea>
            </div>

            <div class="mb-2">
                <div class="d-flex justify-content-between flex-row flex-nowrap">
                    <label class="form-label">Какие вопросы может задать врач пациенту с таким диагнозом? Что на них ответит пациент? Если вы не хотите добавлять вопросы и ответы, оставьте поле пустым.</label>
                    <button class="btn btn-primary mb-2" type="button" data-bs-toggle="popover"
                            data-bs-trigger="hover focus" data-bs-content="Для реализации игровой логики необходимы не только вопросы врача, но и ответы пациента. Плохой пример вопроса: &quot;Как вас зовут?&quot; (вопрос плохой, потому что на него нет ответа и он не несёт полезной информации для игрока, которому нужно угадать диагноз). Хороший пример вопроса: &quot;В: У вас болит живот? Где конкретно?&quot; – &quot;О: Да, болит. Ощущаю спазм где-то внизу живота&quot;">
                        ?
                    </button>
                </div>

                <textarea id="questions" class="form-control" placeholder="Введите варианты вопросов с ответами на них. Если вам необходим пример, воспользуйтесь подсказкой справа." cols="80" rows="5"></textarea>
            </div>
            <button id="send-button" class="btn btn-primary position-absolute start-50 translate-middle-x" type="submit"
                    data-bs-toggle="modal" data-bs-target="#confirm-modal" disabled>
                Отправить
            </button>


        </form>

        <div id="confirm-modal" class="modal fade" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Вы уверены?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Отправить предложенную вами информацию о диагнозе? Пожалуйста, удостоверьтесь, что введённые вами данные не содержат ошибок и неточностей. Обратите внимание на примеры описаний.
                        
                        Заранее большое спасибо вам за ваш вклад!
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button id="submit-button" type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            Да, отправить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
                crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/tom-select@1.1/dist/js/tom-select.complete.min.js"></script>

        <script>
            const pathGET = '/GameContext/Diagnoses'
            const pathPOST = '/GameContext/Suggestion'
            const pathSearch = '/GameContext/DiagnosesBySubstring/'
            const url = document.location.origin.concat(pathGET)
            const urlSearch = document.location.origin.concat(pathSearch)
            const urlPOST = document.location.origin.concat(pathPOST)
            document.body.style.backgroundColor = "#e7f1ff";

            var config = {
                valueField: 'value',
                labelField: 'text',
                searchField: 'text',
                onType: value => {
                    console.log('onType')
                },
                load: function (query, callback) {
                    console.log(`query: ${query}`)

                    var localurl = urlSearch.concat(query);
                    if (query == '') localurl = url
                    console.log(localurl)
                    fetch(localurl)
                        .then(response => response.json())
                        .then(json => {

                            const result = [];
                            for (const item of json.diagnoses) {
                                result.push({ value: item.id, text: item.diagnosis_text.concat(' ').concat(item.mcb_code) });
                            }
                            console.log(result);
                            callback(result);
                        })
                },
                onChange: value => {
                    sendButton.disabled = !dataValid()
                    console.log('change')
                },
                render: {
                    'no_results': function (data, escape) {
                        return '<div class="no-results">Диагноз не найден, возможно, вы допустили опечатку</div>';
                    },
                }
            };
            const select = new TomSelect('#diagnoses', config);

            function initializePopovers() {
                const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
                const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl)
                })
            }

            initializePopovers()

            function dataValid() {
                return diagnosesSelect.value !== '' &&
                    (simptomsInput.value !== '' || visualsInput.value !== '' || questionsInput.value !== '')
            }

            const diagnosisForm = document.getElementById('diagnosis-form')
            diagnosisForm.addEventListener('submit', event => {
                event.preventDefault()
            })

            const diagnosesSelect = document.getElementById('diagnoses')
            const simptomsInput = document.getElementById('simptoms')
            const visualsInput = document.getElementById('visuals')
            const questionsInput = document.getElementById('questions')

            const submitButton = document.getElementById('submit-button')
            submitButton.addEventListener('click', () => {
                const body = {
                    id: parseInt(diagnosesSelect.value),
                    simptoms: simptomsInput.value,
                    visuals: visualsInput.value,
                    questions: questionsInput.value
                }

                console.log(body)

                if (dataValid()) {
                    console.log(JSON.stringify(body))
                    fetch(urlPOST, {
                        method: 'POST',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    })
                }

                window.location.reload()
            })

            const sendButton = document.getElementById('send-button')
            const inputs = document.querySelectorAll('select')
            const textareas = document.querySelectorAll('textarea')

            for (const input of [simptomsInput, visualsInput, questionsInput]) {
                input.addEventListener('input', () => {
                    sendButton.disabled = !dataValid()
                })
            }

        </script>
    </main>
</body>

</html>
